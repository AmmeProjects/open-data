name: Weekly Data Update

on:
  schedule:
    - cron: '0 1 * * 1'   # 00:00 UTC Mondays
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  prepare-branch:
    runs-on: ubuntu-latest
    outputs:
      branch_name: ${{ steps.set_branch.outputs.branch_name }}
      branch_date: ${{ steps.set_branch.outputs.branch_date }}
    steps:
      - id: set_branch
        run: |
          WEEK=$(date -u '+%Y-W%V')
          echo "branch_name=weekly-update-$WEEK" >> $GITHUB_OUTPUT
          echo "branch_date=$WEEK" >> $GITHUB_OUTPUT

  extract-static-spain:
    needs: prepare-branch
    runs-on: ubuntu-latest
    env:
      BRANCH_NAME: ${{ needs.prepare-branch.outputs.branch_name }}
    steps:
      - uses: actions/checkout@v4
      - name: Install uv
        uses: astral-sh/setup-uv@v6
        with:
          enable-cache: true
      - name: Set up Python
        run: uv python install
      - name: Install dependencies
        run: uv sync
      - name: Run Spain NAP update script
        run: uv run python -m scripts.naps.spain
      - name: Commit and Push Spain locations.json
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BRANCH_NAME: ${{ env.BRANCH_NAME }}
        run: |
          uv run python -m src.utils.git_utils \
            data/naps/spain/locations.json \
            "$BRANCH_NAME" \
            "https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}" \
            "Automated Spain update"

  extract-static-portugal:
    needs: prepare-branch
    runs-on: ubuntu-latest
    env:
      BRANCH_NAME: ${{ needs.prepare-branch.outputs.branch_name }}
    steps:
      - uses: actions/checkout@v4
      - name: Install uv
        uses: astral-sh/setup-uv@v6
        with:
          enable-cache: true
      - name: Set up Python
        run: uv python install
      - name: Install dependencies
        run: uv sync
      - name: Run Portugal NAP update script
        run: uv run python -m scripts.naps.portugal
      - name: Commit and Push Portugal locations.json
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BRANCH_NAME: ${{ env.BRANCH_NAME }}
        run: |
          uv run python -m src.utils.git_utils \
            data/naps/portugal/locations.json \
            "$BRANCH_NAME" \
            "https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}" \
            "Automated Portugal update"

  run-mobie-tariffs:
    needs: prepare-branch
    runs-on: ubuntu-latest
    env:
      BRANCH_NAME: ${{ needs.prepare-branch.outputs.branch_name }}
    steps:
      - uses: actions/checkout@v4
      - name: Install uv
        uses: astral-sh/setup-uv@v6
        with:
          enable-cache: true
      - name: Set up Python
        run: uv python install
      - name: Install dependencies
        run: uv sync
      - name: Run mobie_tariffs.py script
        run: uv run python scripts/custom/mobie_tariffs.py
      - name: Commit and Push mobie_tariffs.json
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BRANCH_NAME: ${{ env.BRANCH_NAME }}
        run: |
          uv run python -m src.utils.git_utils \
            data/naps/portugal/history_tariffs \
            "$BRANCH_NAME" \
            "https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}" \
            "Automated mobie_tariffs update"

  create-pr:
    name: Open or update PR
    needs:
      - prepare-branch
      - extract-static-spain
      - extract-static-portugal
      - run-mobie-tariffs
    if: always()
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    env:
      BRANCH_NAME: ${{ needs.prepare-branch.outputs.branch_name }}
      BRANCH_DATE: ${{ needs.prepare-branch.outputs.branch_date }}
    steps:
      - name: Checkout target branch
        uses: actions/checkout@v4
        with:
          ref: ${{ env.BRANCH_NAME }}
          fetch-depth: 0
      - name: Create or View PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          existing_pr=$(gh pr list \
            --head "$BRANCH_NAME" \
            --base main \
            --state open \
            --json number --jq '.[0].number')
          if [ -n "$existing_pr" ]; then
            echo "PR already exists: #$existing_pr"
          else
            TITLE="Weekly data update (${BRANCH_DATE})"
            BODY="Automated weekly data update for ${BRANCH_DATE}."
            gh pr create \
              --base main \
              --head "$BRANCH_NAME" \
              --title "$TITLE" \
              --body "$BODY" \
              --label "data update"
            echo "PR created."
          fi